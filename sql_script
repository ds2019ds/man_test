select o.order_id, p.product_id, o.quantity, o.order_price, o.dispatch_date, p.name,
datediff(day, available_from, dispatch_date) as day_diff
into #tmp
from orders o
left join product p
on o.product_id = p.product_id
where (datediff(day, available_from, dispatch_date) > 30) and
year(o.dispatch_date) = year(GETDATE())-1


select product_id, sum(quantity) as quantity_sum
from #tmp
group by product_id
having sum(quantity) < 10